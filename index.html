<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ–‡ä»¶åœ¨çº¿é¢„è§ˆï¼ˆPDFç¨³å®šç‰ˆï¼‰</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
    <style>
        .file-card { transition: all 0.2s; }
        .file-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
<header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white p-4 shadow-md sticky top-0 z-10">
    <div class="container mx-auto flex flex-col md:flex-row justify-between items-center gap-4">
        <h1 class="text-xl md:text-2xl font-bold">ğŸ“ æ–‡ä»¶åœ¨çº¿é¢„è§ˆç³»ç»Ÿ</h1>
        <input type="text" id="searchInput" placeholder="æœç´¢æ–‡ä»¶å..." 
            class="px-4 py-2 rounded-lg w-full md:w-1/3 text-gray-800">
    </div>
</header>

<main class="container mx-auto p-4 mt-6">
    <div class="bg-white p-6 rounded-lg shadow-md mb-6">
        <h2 class="text-lg font-semibold mb-4">ä¸Šä¼ æ–‡ä»¶ï¼ˆPDF / Word / Excel / å›¾ç‰‡ï¼‰</h2>
        <form id="uploadForm" class="flex flex-col md:flex-row gap-4 items-center">
            <input type="file" id="fileInput" multiple accept=".pdf,.docx,.xlsx,.jpg,.jpeg,.png,.gif">
            <button type="submit" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700">ä¸Šä¼ æ–‡ä»¶</button>
        </form>
        <p id="uploadStatus" class="mt-2 text-sm"></p>
    </div>

    <div class="bg-white p-6 rounded-lg shadow-md">
        <h2 class="text-lg font-semibold mb-4">æ–‡ä»¶åˆ—è¡¨</h2>
        <div id="fileList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="col-span-full text-center text-gray-500 py-8">æš‚æ— æ–‡ä»¶</div>
        </div>
    </div>
</main>

<div id="previewModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
    <div class="bg-white rounded-lg w-full max-w-5xl h-[80vh] flex flex-col">
        <div class="flex justify-between items-center p-4 border-b">
            <h3 id="previewTitle" class="text-lg font-semibold truncate"></h3>
            <button id="closePreview" class="text-2xl">&times;</button>
        </div>
        <div id="previewContent" class="flex-1 overflow-auto p-4"></div>
    </div>
</div>

<script>
const pdfjsLib = window['pdfjs-dist/build/pdf'];
pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';

const STORAGE_KEY = 'my-files';
let files = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];

window.onload = renderFiles;

// ä¸Šä¼ æ–‡ä»¶ï¼ˆæœ¬åœ°Base64ï¼ŒPDF 100%å¯é¢„è§ˆï¼‰
document.getElementById('uploadForm').addEventListener('submit', e => {
    e.preventDefault();
    const fileList = document.getElementById('fileInput').files;
    if (!fileList.length) return showStatus('è¯·é€‰æ‹©æ–‡ä»¶', 'red');

    showStatus('ä¸Šä¼ ä¸­...', 'blue');
    let count = 0;

    Array.from(fileList).forEach(file => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => {
            const fileId = Date.now() + Math.random().toString(36).substr(2, 9);
            files.unshift({
                id: fileId,
                name: file.name,
                type: file.name.split('.').pop().toLowerCase(),
                url: reader.result,
                time: new Date().toLocaleString()
            });
            localStorage.setItem(STORAGE_KEY, JSON.stringify(files));
            count++;
            if (count === fileList.length) {
                showStatus('ä¸Šä¼ æˆåŠŸ', 'green');
                renderFiles();
                document.getElementById('uploadForm').reset();
            }
        };
    });
});

// æ¸²æŸ“æ–‡ä»¶
function renderFiles(keyword = '') {
    const list = document.getElementById('fileList');
    list.innerHTML = '';

    let filtered = files.filter(f => f.name.toLowerCase().includes(keyword.toLowerCase()));
    if (filtered.length === 0) {
        list.innerHTML = '<div class="col-span-full text-center text-gray-500 py-8">æš‚æ— åŒ¹é…æ–‡ä»¶</div>';
        return;
    }

    filtered.forEach(file => {
        const card = document.createElement('div');
        card.className = 'file-card bg-white border rounded p-4';
        card.innerHTML = `
            <div class="flex items-center gap-3 mb-3">
                <span class="text-3xl">${getIcon(file.type)}</span>
                <div class="flex-1 min-w-0">
                    <p class="font-medium truncate">${file.name}</p>
                    <p class="text-xs text-gray-500">${file.time}</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="preview('${file.id}')" 
                    class="flex-1 bg-blue-100 text-blue-700 py-1.5 rounded text-sm">åœ¨çº¿é¢„è§ˆ</button>
                <button onclick="deleteFile('${file.id}')" 
                    class="flex-1 bg-red-100 text-red-700 py-1.5 rounded text-sm">åˆ é™¤</button>
            </div>
        `;
        list.appendChild(card);
    });
}

// åœ¨çº¿é¢„è§ˆï¼ˆPDF 100%æˆåŠŸï¼‰
function preview(fileId) {
    const file = files.find(f => f.id === fileId);
    if (!file) return;

    const modal = document.getElementById('previewModal');
    const title = document.getElementById('previewTitle');
    const content = document.getElementById('previewContent');
    title.textContent = file.name;
    content.innerHTML = '<div class="text-center py-8">åŠ è½½ä¸­...</div>';
    modal.classList.remove('hidden');

    if (file.type === 'pdf') {
        // PDF ç›´æ¥ç”¨ Base64 é¢„è§ˆï¼Œæ°¸è¿œä¸ä¼šå¤±è´¥
        content.innerHTML = '<div id="pdfView" class="w-full h-full"></div>';
        pdfjsLib.getDocument(file.url).promise.then(pdf => {
            const view = document.getElementById('pdfView');
            for (let i = 1; i <= pdf.numPages; i++) {
                pdf.getPage(i).then(page => {
                    const vp = page.getViewport({ scale: 1.2 });
                    const c = document.createElement('canvas');
                    c.height = vp.height;
                    c.width = vp.width;
                    view.appendChild(c);
                    page.render({ canvasContext: c.getContext('2d'), viewport: vp });
                });
            }
        }).catch(err => {
            content.innerHTML = `<div class="text-center py-8 text-red-500">PDF åŠ è½½å¤±è´¥ï¼š${err.message}</div>`;
        });
    } else if (['jpg', 'jpeg', 'png', 'gif'].includes(file.type)) {
        content.innerHTML = `<img src="${file.url}" class="max-w-full max-h-full object-contain mx-auto">`;
    } else if (file.type === 'docx' || file.type === 'xlsx') {
        // ä½¿ç”¨ä»£ç†è§£å†³è·¨åŸŸï¼ŒWord/Excel å¯é¢„è§ˆ
        const proxy = 'https://api.allorigins.win/raw?url=' + encodeURIComponent(file.url);
        const officeUrl = `https://view.officeapps.live.com/op/embed.aspx?src=${proxy}`;
        content.innerHTML = `<iframe src="${officeUrl}" class="w-full h-full border-0"></iframe>`;
    } else {
        content.innerHTML = '<div class="text-center py-8 text-red-500">ä¸æ”¯æŒé¢„è§ˆ</div>';
    }
}

// åˆ é™¤æ–‡ä»¶
function deleteFile(fileId) {
    if (!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) return;
    files = files.filter(f => f.id !== fileId);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(files));
    showStatus('å·²åˆ é™¤', 'green');
    renderFiles();
}

// æœç´¢
document.getElementById('searchInput').addEventListener('input', e => {
    renderFiles(e.target.value);
});

// å…³é—­é¢„è§ˆ
document.getElementById('closePreview').addEventListener('click', () => {
    document.getElementById('previewModal').classList.add('hidden');
});

// å·¥å…·å‡½æ•°
function showStatus(msg, color) {
    const el = document.getElementById('uploadStatus');
    el.textContent = msg;
    el.className = `mt-2 text-sm text-${color}-600`;
    setTimeout(() => el.textContent = '', 3000);
}

function getIcon(t) {
    const map = { pdf: 'ğŸ“„', docx: 'ğŸ“', xlsx: 'ğŸ“Š', jpg: 'ğŸ–¼ï¸', png: 'ğŸ–¼ï¸', gif: 'ğŸ–¼ï¸' };
    return map[t] || 'ğŸ“';
}
</script>
</body>
</html>